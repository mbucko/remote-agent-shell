// ntfy signaling relay messages for WebRTC connection establishment
// Used when direct HTTP connection fails due to NAT
// Shared between: Python daemon, Android app, iOS app

syntax = "proto3";

package ras;

option java_package = "com.ras.proto";
option java_multiple_files = true;
option swift_prefix = "RAS";

// Message sent via ntfy for signaling relay
// Encrypted with signaling_key (AES-256-GCM) before sending
// Wire format: base64(IV + ciphertext + tag)
message NtfySignalMessage {
  // Message type
  MessageType type = 1;

  enum MessageType {
    OFFER = 0;        // Phone -> Daemon: WebRTC offer
    ANSWER = 1;       // Daemon -> Phone: WebRTC answer
    CAPABILITIES = 2; // Bidirectional: Exchange connection capabilities
  }

  // Session ID from QR code (must match pending session)
  // Empty string for reconnection mode
  string session_id = 2;

  // SDP content in raw format (NOT JSON-wrapped).
  // WebRTC offer or answer with full ICE candidates included.
  // Must start with "v=" (SDP version line).
  // Example: "v=0\r\no=- 12345 1 IN IP4 127.0.0.1\r\ns=-\r\n..."
  string sdp = 3;

  // Device info (required in OFFER, optional in ANSWER)
  string device_id = 4;
  string device_name = 5;

  // Replay protection
  int64 timestamp = 6;   // Unix timestamp (seconds)
  bytes nonce = 7;       // 16 random bytes (CSPRNG)

  // Connection capabilities (used with CAPABILITIES type)
  ConnectionCapabilities capabilities = 8;
}

// Connection capabilities for strategy negotiation.
// Exchanged before attempting connection to determine best method.
message ConnectionCapabilities {
  // Tailscale VPN info (if available)
  string tailscale_ip = 1;     // e.g., "100.107.50.54"
  int32 tailscale_port = 2;    // e.g., 9876

  // Supported connection methods
  bool supports_webrtc = 3;    // Standard P2P (always true)
  bool supports_turn = 4;      // TURN relay (if configured)

  // Protocol version for compatibility
  int32 protocol_version = 5;  // Current: 1
}
